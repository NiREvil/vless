<script>
  function copyToClipboard(button, text) {
        const originalHTML = button.innerHTML;
        navigator.clipboard.writeText(text).then(() => {
          button.innerHTML = \`<svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> Copied!\`;
          button.classList.add("copied");
          button.disabled = true;
          setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove("copied");
            button.disabled = false;
          }, 1200);
        }).catch(err => {
          console.error("Failed to copy text: ", err);
        });
      }

      async function fetchClientPublicIP() {
        try {
          const response = await fetch('https://api.ipify.org?format=json');
          if (!response.ok) throw new Error(\`HTTP error! status: \${response.status}\`);
          return (await response.json()).ip;
        } catch (error) {
          console.error('Error fetching client IP:', error);
          return null;
        }
      }

      async function fetchScamalyticsClientInfo(clientIp) {
        if (!clientIp) return null;
        try {
          const response = await fetch(\`/scamalytics-lookup?ip=\${encodeURIComponent(clientIp)}\`);
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(\`Worker request failed! status: \${response.status}, details: \${errorText}\`);
          }
          const data = await response.json();
          if (data.scamalytics && data.scamalytics.status === 'error') {
              throw new Error(data.scamalytics.error || 'Scamalytics API error via Worker');
          }
          return data;
        } catch (error) {
          console.error('Error fetching from Scamalytics via Worker:', error);
          return null;
        }
      }

      // Extract information from IP databases
      function updateScamalyticsClientDisplay(data) {
        const prefix = 'client';
        if (!data || !data.scamalytics || data.scamalytics.status !== 'ok') {
          showError(prefix, (data && data.scamalytics && data.scamalytics.error) || 'Could not load client data from Scamalytics');
          return;
        }

        const sa = data.scamalytics;
        const ext = data.external_datasources || {};

        // Alternative sources for extracting information
        const ipinfo = ext.ipinfo || {};
        const maxmind = ext.maxmind_geolite2 || {};
        const dbip = ext.dbip || {};

        const elements = {
          ip: document.getElementById(\`\${prefix}-ip\`),
          location: document.getElementById(\`\${prefix}-location\`),
          isp: document.getElementById(\`\${prefix}-isp\`),
          proxy: document.getElementById(\`\${prefix}-proxy\`)
        };

        // Helper function for data validation
        const isValid = (val) => val && val !== "PREMIUM FIELD - upgrade to view" && val.trim() !== "";

        // IP display (Your connection)
        if (elements.ip) elements.ip.textContent = sa.ip || "N/A";

        // Show ISP - priority is given to ipinfo
        let ispName = "N/A";
        if (isValid(ipinfo.as_name)) ispName = ipinfo.as_name;
        else if (isValid(maxmind.as_name)) ispName = maxmind.as_name;
        else if (isValid(sa.scamalytics_isp)) ispName = sa.scamalytics_isp;
        else if (isValid(dbip.isp_name)) ispName = dbip.isp_name;

        if (elements.isp) elements.isp.textContent = ispName;

        // Show location (city and country)
        if (elements.location) {
          let city = "";
          let countryName = "";
          let countryCode = "";

          // Trying to find a city
          if (isValid(maxmind.ip_city)) city = maxmind.ip_city;
          else if (isValid(dbip.ip_city)) city = dbip.ip_city;

          // Trying to find a country
          if (isValid(ipinfo.ip_country_name)) {
             countryName = ipinfo.ip_country_name;
             countryCode = ipinfo.ip_country_code;
          } else if (isValid(maxmind.ip_country_name)) {
             countryName = maxmind.ip_country_name;
             countryCode = maxmind.ip_country_code;
          } else if (isValid(dbip.ip_country_name)) {
             countryName = dbip.ip_country_name;
             countryCode = dbip.ip_country_code;
          }

          countryCode = countryCode ? countryCode.toLowerCase() : '';

          let flagElementHtml = countryCode ? \`<img src="https://flagcdn.com/w20/\${countryCode}.png" srcset="https://flagcdn.com/w40/\${countryCode}.png 2x" alt="\${countryCode}" class="country-flag"> \` : '';
          let textPart = [city, countryName].filter(Boolean).join(', ');

          elements.location.innerHTML = (flagElementHtml || textPart) ? \`\${flagElementHtml}\${textPart}\`.trim() : "N/A";
        }

        // Show risk score
        if (elements.proxy) {
          const score = sa.scamalytics_score;
          const risk = sa.scamalytics_risk;
          let riskText = "Unknown";
          let badgeClass = "badge-neutral";
          if (risk && score !== undefined) {
              riskText = \`\${score} - \${risk.charAt(0).toUpperCase() + risk.slice(1)}\`;
              switch (risk.toLowerCase()) {
                  case "low": badgeClass = "badge-yes"; break;
                  case "medium": badgeClass = "badge-warning"; break;
                  case "high": case "very high": badgeClass = "badge-no"; break;
              }
          }
          elements.proxy.innerHTML = \`<span class="badge \${badgeClass}">\${riskText}</span>\`;
        }
      }

      function updateIpApiIoDisplay(geo, prefix, originalHost) {
        const hostElement = document.getElementById(\`\${prefix}-host\`);
        if (hostElement) hostElement.textContent = originalHost || "N/A";
        const elements = {
          ip: document.getElementById(\`\${prefix}-ip\`), location: document.getElementById(\`\${prefix}-location\`),
          isp: document.getElementById(\`\${prefix}-isp\`)
        };
        if (!geo || geo.error) {
          const errorMessage = geo ? geo.reason : 'N/A';
          Object.values(elements).forEach(el => { if(el) el.innerHTML = errorMessage; });
          if (elements.ip) elements.ip.innerHTML = "N/A";
          return;
        }
        if (elements.ip) elements.ip.textContent = geo.ip || "N/A";
        if (elements.location) {
          const city = geo.city || '';
          const countryName = geo.country_name || '';
          const countryCode = geo.country_code ? geo.country_code.toLowerCase() : '';
          let flagElementHtml = countryCode ? \`<img src="https://flagcdn.com/w20/\${countryCode}.png" srcset="https://flagcdn.com/w40/\${countryCode}.png 2x" alt="\${geo.country_code}" class="country-flag"> \` : '';
          let textPart = [city, countryName].filter(Boolean).join(', ');
          elements.location.innerHTML = (flagElementHtml || textPart) ? \`\${flagElementHtml}\${textPart}\`.trim() : "N/A";
        }
        if (elements.isp) elements.isp.textContent = geo.isp || geo.organization || geo.org || 'N/A';
      }


      async function fetchIpApiIoInfo(ip) {
        try {
          const response = await fetch(\`https://ipapi.co/\${ip}/json/\`);
          if (!response.ok) throw new Error(\`HTTP error! status: \${response.status}\`);
          return await response.json();
        } catch (error) {
          console.error('IP API Error (ipapi.co):', error);
          return null;
        }
      }

      function showError(prefix, message = "Could not load data", originalHostForProxy = null) {
        const errorMessage = "N/A";
        const elements = (prefix === 'proxy')
          ? ['host', 'ip', 'location', 'isp']
          : ['ip', 'location', 'isp', 'proxy'];

        elements.forEach(key => {
          const el = document.getElementById(\`\${prefix}-\${key}\`);
          if (!el) return;
          if (key === 'host' && prefix === 'proxy') el.textContent = originalHostForProxy || errorMessage;
          else if (key === 'proxy' && prefix === 'client') el.innerHTML = \`<span class="badge badge-neutral">N/A</span>\`;
          else el.innerHTML = errorMessage;
        });
        console.warn(\`\${prefix} data loading failed: \${message}\`);
      }

      async function loadNetworkInfo() {
        try {
          const proxyIpWithPort = document.body.getAttribute('data-proxy-ip') || "N/A";
          const proxyDomainOrIp = proxyIpWithPort.split(':')[0];
          const proxyHostEl = document.getElementById('proxy-host');
          if(proxyHostEl) proxyHostEl.textContent = proxyIpWithPort;

          if (proxyDomainOrIp && proxyDomainOrIp !== "N/A") {
            let resolvedProxyIp = proxyDomainOrIp;
            if (!/^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}$/.test(proxyDomainOrIp)) {
              try {
                const dnsRes = await fetch(\`https://dns.google/resolve?name=\${encodeURIComponent(proxyDomainOrIp)}&type=A\`);
                if (dnsRes.ok) {
                    const dnsData = await dnsRes.json();
                    const ipAnswer = dnsData.Answer?.find(a => a.type === 1);
                    if (ipAnswer) resolvedProxyIp = ipAnswer.data;
                }
              } catch (e) { console.error('DNS resolution for proxy failed:', e); }
            }
            const proxyGeoData = await fetchIpApiIoInfo(resolvedProxyIp);
            updateIpApiIoDisplay(proxyGeoData, 'proxy', proxyIpWithPort);
          } else {
            showError('proxy', 'Proxy Host not available', proxyIpWithPort);
          }

          const clientIp = await fetchClientPublicIP();
          if (clientIp) {
            const clientIpElement = document.getElementById('client-ip');
            if(clientIpElement) clientIpElement.textContent = clientIp;
            const scamalyticsData = await fetchScamalyticsClientInfo(clientIp);
            updateScamalyticsClientDisplay(scamalyticsData);
          } else {
            showError('client', 'Could not determine your IP address.');
          }
        } catch (error) {
          console.error('Overall network info loading failed:', error);
          showError('proxy', \`Error: \${error.message}\`, document.body.getAttribute('data-proxy-ip') || "N/A");
          showError('client', \`Error: \${error.message}\`);
        }
      }

      document.getElementById('refresh-ip-info')?.addEventListener('click', function() {
        const button = this;
        const icon = button.querySelector('.refresh-icon');
        button.disabled = true;
        if (icon) icon.style.animation = 'spin 1s linear infinite';

        const resetToSkeleton = (prefix) => {
          const elementsToReset = ['ip', 'location', 'isp'];
          if (prefix === 'proxy') elementsToReset.push('host');
          if (prefix === 'client') elementsToReset.push('proxy');
          elementsToReset.forEach(key => {
            const element = document.getElementById(\`\${prefix}-\${key}\`);
            if (element) element.innerHTML = \`<span class="skeleton" style="width: 120px;"></span>\`;
          });
        };

        resetToSkeleton('proxy');
        resetToSkeleton('client');
        loadNetworkInfo().finally(() => setTimeout(() => {
          button.disabled = false; if (icon) icon.style.animation = '';
        }, 1000));
      });

      const style = document.createElement('style');
      style.textContent = \`@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }\`;
      document.head.appendChild(style);

      document.addEventListener('DOMContentLoaded', () => {
        loadNetworkInfo();

        const hiddifyBtn = document.getElementById('hiddify-import-btn');
        const modal = document.getElementById('hiddify-dns-modal');
        const continueBtn = document.getElementById('hiddify-modal-continue');

        if (hiddifyBtn && modal && continueBtn) {
          hiddifyBtn.addEventListener('click', function(event) {
            event.preventDefault();
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('visible'), 10);
          });

          continueBtn.addEventListener('click', function() {
            modal.classList.remove('visible');
            setTimeout(() => {
                modal.style.display = 'none';
                window.location.href = hiddifyBtn.href;
            }, 300);
          });

          modal.addEventListener('click', function(event) {
            if (event.target === modal) {
              modal.classList.remove('visible');
              setTimeout(() => modal.style.display = 'none', 300);
            }
          });
        }
      });
</script>
